<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <GenerateAssemblyCompanyAttribute>false</GenerateAssemblyCompanyAttribute>
    <GenerateAssemblyConfigurationAttribute>false</GenerateAssemblyConfigurationAttribute>
    <GenerateAssemblyFileVersionAttribute>false</GenerateAssemblyFileVersionAttribute>
    <GenerateAssemblyInformationalVersionAttribute>false</GenerateAssemblyInformationalVersionAttribute>
    <GenerateAssemblyProductAttribute>false</GenerateAssemblyProductAttribute>
    <GenerateAssemblyTitleAttribute>false</GenerateAssemblyTitleAttribute>
    <GenerateAssemblyVersionAttribute>false</GenerateAssemblyVersionAttribute>
    <ILCompilerVersion>1.0.0-alpha-28010-01</ILCompilerVersion>
    <IlcOptimizationPreference>Size</IlcOptimizationPreference>
    <IlcDisableReflection>true</IlcDisableReflection>
    <NativeLib>Static</NativeLib>
    <NoWarn>CS2008</NoWarn>
    <Optimize>true</Optimize>
    <RootAllApplicationAssemblies>true</RootAllApplicationAssemblies>
    <TargetFramework>netstandard2.0</TargetFramework>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.ILCompiler" Version="$(ILCompilerVersion)" />
    <Reference Include="assembly">
      <HintPath>$(AutocratOutputAssembly)</HintPath>
    </Reference>
  </ItemGroup>

  <!-- Ensure the types in our generated assembly are sent to the IL compiler too -->
  <ItemGroup>
    <IlcArg Include="assembly.dll" />
    <IlcArg Include="Autocrat.NativeAdapters.dll" />
  </ItemGroup>

  <Target Name="VCEnvironment">
    <ItemGroup>
      <VSWhereArgs Include="-latest" />
      <VSWhereArgs Include="-products *" />
      <VSWhereArgs Include="-property installationPath" />
      <VSWhereArgs Include="-requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64" />
    </ItemGroup>

    <Exec Command="&quot;%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe&quot; @(VSWhereArgs, ' ')"
          ConsoleToMSBuild="true"
          StandardOutputImportance="Low">
      <Output TaskParameter="ConsoleOutput" PropertyName="VsInstanceDir"/>
    </Exec>

    <PropertyGroup>
      <VCSetEnvironment>CALL "$(VsInstanceDir)\Common7\Tools\vsdevcmd.bat" -arch=x64 > NUL</VCSetEnvironment>
    </PropertyGroup>
  </Target>

  <Target Name="AutocratCompile"
          AfterTargets="Publish"
          DependsOnTargets="VCEnvironment">
    <ItemGroup>
      <CompilerOptions Include="/c" />
      <CompilerOptions Include="/D &quot;_MBCS&quot;" />
      <CompilerOptions Include="/D &quot;NDEBUG&quot;" />
      <CompilerOptions Include="/EHsc" />
      <CompilerOptions Include="/Fo&quot;main.obj&quot;" />
      <CompilerOptions Include="/Gd" />
      <CompilerOptions Include="/GS" />
      <CompilerOptions Include="/I&quot;$(AutocratBootstrapDir)&quot;" />
      <CompilerOptions Include="/MT" />
      <CompilerOptions Include="/nologo" />
      <CompilerOptions Include="/O2" />
      <CompilerOptions Include="/std:c++17" />
      <CompilerOptions Include="/w" />
      <CompilerOptions Include="/Zc:inline" />
    </ItemGroup>

    <Message Importance="high" Text="Compiling native code"/>
    <Exec Command="$(VCSetEnvironment) &amp; cl.exe @(CompilerOptions, ' ') $(AutocratOutputSource)"
          IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="CLExitCode" />
    </Exec>
    <Error Condition="'$(CLExitCode)' != '0'" Text="Native compilation failed." />
  </Target>

  <Target Name="AutocratLink"
          AfterTargets="AutocratCompile"
          DependsOnTargets="VCEnvironment">
    <PropertyGroup>
      <RuntimeLibraryFolder>$(NuGetPackageFolders.Split(';')[0])/runtime.win-x64.microsoft.dotnet.ilcompiler/$(ILCompilerVersion)/sdk/</RuntimeLibraryFolder>
    </PropertyGroup>

    <ItemGroup>
      <AutocratFiles Include="$(AutocratBootstrapDir)Autocrat.Bootstrap.lib" />
      <AutocratFiles Include="main.obj" />
      <AutocratFiles Include="$(PublishDir)ManagedToNative.lib" />
      <LinkerOptions Include="/DYNAMICBASE" />
      <LinkerOptions Include="/MACHINE:X64" />
      <LinkerOptions Include="/MANIFEST:NO" />
      <LinkerOptions Include="/NOLOGO" />
      <LinkerOptions Include="/NXCOMPAT" />
      <LinkerOptions Include="/OPT:ICF" />
      <LinkerOptions Include="/OPT:REF" />
      <LinkerOptions Include="/OUT:&quot;$(OutputName)&quot;" />
      <LinkerOptions Include="/SUBSYSTEM:CONSOLE" />
      <RuntimeLibraries Include="$(RuntimeLibraryFolder)bootstrapperdll.lib" />
      <RuntimeLibraries Include="$(RuntimeLibraryFolder)Runtime.lib" />
      <RuntimeLibraries Include="$(RuntimeLibraryFolder)System.Private.TypeLoader.Native.lib" />
    </ItemGroup>

    <Message Importance="high" Text="Linking executable"/>
    <Exec Command="$(VCSetEnvironment) &amp; link.exe @(LinkerOptions, ' ') @(NativeLibrary, ' ') @(RuntimeLibraries, ' ') @(AutocratFiles, ' ')"
          IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="LinkExitCode" />
    </Exec>
    <Error Condition="'$(LinkExitCode)' != '0'" Text="Linking failed." />
    <Message Importance="high" Text="Generated $(OutputName)"/>
  </Target>
</Project>
