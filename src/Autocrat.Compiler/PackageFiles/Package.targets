<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="AutocratTarget"
          AfterTargets="Publish">
    <ItemGroup>
      <AdditionalProjectOptions Include="/p:AutocratBootstrapDir=&quot;$(MSBuildThisFileDirectory)../content/bootstrap/&quot;" />
      <AdditionalProjectOptions Include="/p:AutocratOutputAssembly=&quot;$(AutocratOutputAssembly)&quot;" />
      <AdditionalProjectOptions Include="/p:AutocratOutputSource=&quot;$(AutocratOutputSource)&quot;" />
      <AdditionalProjectOptions Include="/p:OutputName=&quot;$(ProjectDir)$(PublishDir)$(TargetName).exe&quot;" />

      <!-- Make sure all the dependencies are available -->
      <PublishedFiles Include="$(PublishDir)*.*" />
    </ItemGroup>

    <Exec Command="dotnet $(AutocratCompiler) --assembly $(AutocratOutputAssembly) --source $(AutocratOutputSource) $(ProjectPath)" />

    <Move SourceFiles="@(PublishedFiles)"
          DestinationFolder="$(AutocratOutputDirectory)" />
    
    <Copy SourceFiles="@(AutocratProjectFiles)"
          DestinationFolder="$(AutocratOutputDirectory)" />
    
    <Copy SourceFiles="$(AutocratCompiler)"
          DestinationFolder="$(AutocratOutputDirectory)" />

    <!-- There are so many issues around trying to get a MSBuild task to restore -->
    <!-- and work correctly, we'll just cheat and start a new process to do it all -->
    <Exec Command="dotnet publish -c $(ConfigurationName) -r win-x64 $(AutocratManagedProject) -o publish @(AdditionalProjectOptions, ' ')"
          WorkingDirectory="$(AutocratOutputDirectory)" />
    
    <!-- Do a little cleaning -->
    <RemoveDir Directories="$(AutocratOutputDirectory)bin;$(AutocratOutputDirectory)publish" />
  </Target>
</Project>
