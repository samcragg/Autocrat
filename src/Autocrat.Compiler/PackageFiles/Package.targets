<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Autocrat.Compiler.AutocratTask"
             AssemblyFile="$(AutocratCompiler)" />

  <Target Name="AutocratTarget"
          AfterTargets="Publish"
          DependsOnTargets="ResolveAssemblyReferences;_GetAssemblyInfoFromTemplateFile">
    <ItemGroup>
      <AdditionalProjectOptions Include="/p:AutocratContentDir=&quot;$(MSBuildThisFileDirectory)../content/&quot;" />
      <AdditionalProjectOptions Include="/p:AutocratOutputAssembly=&quot;$(AutocratOutputAssembly)&quot;" />
      <AdditionalProjectOptions Include="/p:AutocratOutputSource=&quot;$(AutocratOutputSource)&quot;" />
      <AdditionalProjectOptions Include="/p:OutputName=&quot;$(ProjectDir)$(PublishDir)$(TargetName)&quot;" />

      <!-- Make sure all the dependencies are available -->
      <PublishedFiles Include="$(PublishDir)*.*" />
    </ItemGroup>

    <AutocratTask OutputAssembly="$(AutocratOutputAssembly)"
                  OutputSource="$(AutocratOutputSource)"
                  References="@(ReferencePath)"
                  Sources="@(Compile)" />

    <Move SourceFiles="@(PublishedFiles)"
          DestinationFolder="$(AutocratOutputDirectory)" />
    
    <Copy SourceFiles="@(AutocratProjectFiles)"
          DestinationFolder="$(AutocratOutputDirectory)" />
    
    <!-- There are so many issues around trying to get a MSBuild task to restore -->
    <!-- and work correctly, we'll just cheat and start a new process to do it all -->
    <Exec Command="dotnet publish -c $(ConfigurationName) $(AutocratManagedProject) -o publish @(AdditionalProjectOptions, ' ')"
          WorkingDirectory="$(AutocratOutputDirectory)" />
    
    <!-- Do a little cleaning -->
    <RemoveDir Directories="$(AutocratOutputDirectory)bin;$(AutocratOutputDirectory)publish" />
  </Target>
</Project>
